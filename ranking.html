<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title> Ranking szczeg贸owy</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: Arial, sans-serif;
  background:#111;
  color:#fff;
  padding:20px;
}
h1, h2 { text-align:center; }
.info { text-align:center; margin-bottom:20px; }
table {
  width:100%;
  max-width:800px;
  margin:auto 0 30px 0;
  border-collapse:collapse;
}
th,td {
  border:1px solid #444;
  padding:10px;
  text-align:center;
}
th { background:#222; }
button.deleteRec {
  padding:4px 8px;
  background:red;
  color:white;
  border:none;
  border-radius:4px;
  cursor:pointer;
}
canvas { max-width:800px; margin:auto; display:block; }
</style>
</head>
<body>

<h1> Ranking szczeg贸owy</h1>
<div class="info">
1 miejsce = 3 pkt, 2 miejsce = 2 pkt, 3 miejsce = 1 pkt
</div>

<h2> Podsumowanie punkt贸w</h2>
<table id="summary">
<tr><th>#</th><th>Imi</th><th>Wygrane 1 miejsca</th><th>Punkty</th></tr>
</table>

<h2> Historia rekord贸w</h2>
<table id="history">
<tr><th>#</th><th>Imi</th><th>Miejsce</th><th>Data</th><th>X</th></tr>
</table>

<h2> Wykres punkt贸w</h2>
<canvas id="chart"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, onSnapshot, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import Chart from "https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.esm.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCEEVCSx2uOOggu_4y_gUo4WMyKqf-HlKI",
  authDomain: "obstaiwanie.firebaseapp.com",
  projectId: "obstaiwanie"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const summaryTable = document.getElementById("summary");
const historyTable = document.getElementById("history");
const ctx = document.getElementById("chart").getContext("2d");
let chart;

function pointsByPlace(place){
  if(place===1) return 3;
  if(place===2) return 2;
  if(place===3) return 1;
  return 0;
}

// Pobieranie danych ranking
onSnapshot(collection(db,"ranking"), snap => {
  const data = [];
  snap.forEach(d => {
    data.push({name:d.id, ...d.data()});
  });

  // Sortowanie po punktach (1 miejsce = 3 pkt)
  const summary = data.map(u=>{
    // wins1 = ile 1 miejsca
    let wins1 = u.wins || 0;
    let points = wins1*3; // teraz tylko 1 miejsca, w praktyce mo偶esz doda inne
    return {name:u.name, wins1, points};
  });
  summary.sort((a,b)=>b.points-a.points);

  summaryTable.innerHTML="<tr><th>#</th><th>Imi</th><th>Wygrane 1 miejsca</th><th>Punkty</th></tr>";
  summary.forEach((u,i)=>{
    summaryTable.innerHTML += `<tr>
      <td>${i+1}</td>
      <td>${u.name}</td>
      <td>${u.wins1}</td>
      <td>${u.points}</td>
    </tr>`;
  });

  // Wykres
  const labels = summary.map(u=>u.name);
  const values = summary.map(u=>u.points);
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets:[{
        label:'Punkty',
        data: values,
        backgroundColor:'rgba(0,123,255,0.6)',
        borderColor:'rgba(0,123,255,1)',
        borderWidth:1
      }]
    },
    options:{scales:{y:{beginAtZero:true}}}
  });
});

// Historia rekord贸w (szczeg贸y ka偶dej gry)
onSnapshot(collection(db,"records"), snap=>{
  const recs = [];
  snap.forEach(d=>{
    recs.push({id:d.id, ...d.data()});
  });
  recs.sort((a,b)=>new Date(b.date) - new Date(a.date));

  historyTable.innerHTML="<tr><th>#</th><th>Imi</th><th>Miejsce</th><th>Data</th><th>X</th></tr>";
  recs.forEach((r,i)=>{
    const dt = new Date(r.date).toLocaleDateString("pl-PL");
    historyTable.innerHTML += `<tr>
      <td>${i+1}</td>
      <td>${r.name}</td>
      <td>${r.place}</td>
      <td>${dt}</td>
      <td><button class="deleteRec" onclick="deleteRecord('${r.id}')">X</button></td>
    </tr>`;
  });
});

window.deleteRecord = async (id)=>{
  await deleteDoc(doc(db,"records",id));
};
</script>
</body>
</html>
