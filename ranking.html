<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>ğŸ† Ranking ZwyciÄ™zcÃ³w</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; background: #f2f2f2; color: #111; padding: 20px; text-align: center; transition: background-color 0.3s, color 0.3s; }
        body.dark { background: #111; color: #fff; }

        .points-box { background: white; max-width: 500px; margin: 20px auto; padding: 15px; border-radius: 10px; border: 1px solid #ccc; color: #d4af37; font-weight: bold; transition: 0.3s; }
        body.dark .points-box { background: #222; border-color: #444; color: #ffcc00; }

        table { width: 100%; max-width: 750px; margin: 20px auto; border-collapse: collapse; background: white; transition: 0.3s; }
        body.dark table { background: #1a1a1a; }

        th, td { border: 1px solid #ccc; padding: 12px; text-align: center; }
        body.dark th, body.dark td { border-color: #333; }

        th { background: #eee; }
        body.dark th { background: #222; }

        .deleteBtn { width: 24px; height: 24px; line-height: 24px; border-radius: 50%; background: #ffdddd; border: 1px solid red; color: red; cursor: pointer; display: inline-block; font-weight: bold; }
        .deleteBtn:hover { background: red; color: white; }

        .clear-btn { background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 40px; font-weight: bold; }
        .clear-btn:hover { background: #c0392b; }

        #darkModeBtn { position: fixed; top: 15px; right: 15px; padding: 10px 18px; border-radius: 30px; border: none; cursor: pointer; font-size: 14px; font-weight: bold; background: #111; color: #fff; z-index: 100000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: 0.3s; }
        body.dark #darkModeBtn { background: #f1f1f1; color: #111; }

        h2 { margin-top: 60px; border-top: 1px solid #444; padding-top: 20px; }
    </style>
</head>
<body class="dark"> 
    <button id="darkModeBtn">â˜€ï¸ Light mode</button>

    <h1>ğŸ† Ranking zwyciÄ™zcÃ³w</h1>

    <div class="points-box">
        ğŸ¥‡ 1. miejsce: 3 pkt | ğŸ¥ˆ 2. miejsce: 2 pkt | ğŸ¥‰ 3. miejsce: 1 pkt
    </div>

    <table id="rankTable">
        <tr><th>#</th><th>IMIÄ˜</th><th>SUMA PUNKTÃ“W</th></tr>
    </table>

    <h2>ğŸ“‹ Historia rekordÃ³w (Ostatnie zapisy)</h2>
    <table id="historyTable">
        <tr><th>Data i Godzina</th><th>Wyniki (Miejsca)</th><th>X</th></tr>
    </table>

    <button class="clear-btn" onclick="clearAllData()">ğŸ—‘ï¸ WyczyÅ›Ä‡ wszystko (Ranking i HistoriÄ™)</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, getDocs, deleteDoc, doc, 
            updateDoc, getDoc, query, orderBy, limit 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCEEVCSx2uOOggu_4y_gUo4WMyKqf-HlKI",
            authDomain: "obstaiwanie.firebaseapp.com",
            projectId: "obstaiwanie"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DARK MODE
        const darkBtn = document.getElementById("darkModeBtn");
        darkBtn.onclick = () => {
            document.body.classList.toggle("dark");
            darkBtn.textContent = document.body.classList.contains("dark") ? "â˜€ï¸ Light mode" : "ğŸŒ™ Dark mode";
        };

        // 1. POBIERANIE RANKINGU OGÃ“LNEGO
        onSnapshot(collection(db, "ranking"), snap => {
            let players = [];
            snap.forEach(d => {
                const val = d.data().points || 0;
                players.push({ name: d.id, points: val });
            });
            players.sort((a, b) => b.points - a.points);
            const rankTable = document.getElementById("rankTable");
            rankTable.innerHTML = "<tr><th>#</th><th>IMIÄ˜</th><th>SUMA PUNKTÃ“W</th></tr>";
            players.forEach((p, i) => {
                rankTable.innerHTML += `<tr><td>${i+1}</td><td>${p.name}</td><td>${p.points}</td></tr>`;
            });
        });

        // 2. POBIERANIE HISTORII Z DYNAMICZNYM WYÅšWIETLANIEM MIEJSC
        onSnapshot(query(collection(db, "history"), orderBy("timestamp", "desc"), limit(25)), snap => {
            const historyTable = document.getElementById("historyTable");
            historyTable.innerHTML = "<tr><th>Data i Godzina</th><th>Wyniki (Miejsca)</th><th>X</th></tr>";
            
            snap.forEach(d => {
                const data = d.data();
                
                // JeÅ›li dokument zawiera juÅ¼ informacjÄ™ o rankingu (zapisaliÅ›my jÄ… w stopBtn)
                const results = data.winners.map(w => {
                    // Sprawdzamy czy mamy pole 'rank', jeÅ›li nie (stare rekordy), uÅ¼ywamy domyÅ›lnej kolejnoÅ›ci
                    const rankDisplay = w.rank ? w.rank : (data.winners.indexOf(w) + 1);
                    return `${rankDisplay}. ${w.name}`;
                }).join(", ");

                historyTable.innerHTML += `
                    <tr>
                        <td>${data.date}</td>
                        <td style="font-size: 0.9em;">${results}</td>
                        <td><span class="deleteBtn" onclick="deleteHistoryRecord('${d.id}')">X</span></td>
                    </tr>`;
            });
        });

        // 3. USUWANIE I COFANIE PUNKTÃ“W
        window.deleteHistoryRecord = async (historyId) => {
            if(!confirm("Czy na pewno usunÄ…Ä‡ ten rzut i odjÄ…Ä‡ punkty?")) return;
            
            const recordRef = doc(db, "history", historyId);
            const recordSnap = await getDoc(recordRef);
            
            if(recordSnap.exists()) {
                const data = recordSnap.data();
                for (let i = 0; i < data.winners.length; i++) {
                    const player = data.winners[i];
                    
                    // Wyliczamy punkty do odjÄ™cia na podstawie rangi zapisanej w historii
                    // JeÅ›li rangi nie ma (stare rekordy), uÅ¼ywamy domyÅ›lnego systemu 3-2-1
                    let ptsToSubtract = 0;
                    const r = player.rank ? player.rank : (i + 1);
                    
                    if(r === 1) ptsToSubtract = -3;
                    else if(r === 2) ptsToSubtract = -2;
                    else if(r === 3) ptsToSubtract = -1;

                    const rankRef = doc(db, "ranking", player.name);
                    const playerSnap = await getDoc(rankRef);
                    
                    if (playerSnap.exists()) {
                        const newPoints = (playerSnap.data().points || 0) + ptsToSubtract;
                        if (newPoints <= 0) {
                            await deleteDoc(rankRef);
                        } else {
                            await updateDoc(rankRef, { points: newPoints });
                        }
                    }
                }
                await deleteDoc(recordRef);
            }
        };

        // 4. PEÅNE CZYSZCZENIE
        window.clearAllData = async () => {
            if(!confirm("Czy na pewno chcesz wyczyÅ›ciÄ‡ WSZYSTKIE dane?")) return;
            const promises = [];
            const rSnap = await getDocs(collection(db, "ranking"));
            rSnap.forEach(d => promises.push(deleteDoc(doc(db, "ranking", d.id))));
            const hSnap = await getDocs(collection(db, "history"));
            hSnap.forEach(d => promises.push(deleteDoc(doc(db, "history", d.id))));
            await Promise.all(promises);
            alert("Baza wyczyszczona.");
        };
    </script>
</body>
</html>
