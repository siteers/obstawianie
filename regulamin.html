<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Regulamin & Cyfrowy Podpis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 20px; display: flex; justify-content: center; transition: 0.3s; }
        body.dark { background: #121212; color: #eee; }
        .container { max-width: 800px; width: 100%; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        body.dark .container { background: #1e1e1e; }
        
        h1, h2 { color: #007bff; text-align: center; }
        .rules-box { background: #f9f9f9; padding: 20px; border-radius: 10px; border-left: 5px solid #007bff; margin-bottom: 20px; }
        body.dark .rules-box { background: #2a2a2a; color: #ccc; }
        
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        body.dark th, body.dark td { border-color: #444; }

        /* SEKCJA AKCEPTACJI */
        .acceptance-flow { text-align: center; margin-top: 40px; padding: 20px; border-top: 2px solid #eee; }
        
        /* SKANER */
        #scan-zone {
            width: 100px; height: 100px; background: #fff; border: 4px solid #007bff;
            border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
            font-size: 40px; cursor: pointer; position: relative; transition: 0.3s; margin: 20px auto;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .pulse { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 4px solid #007bff; animation: pulse 1.5s infinite; opacity: 0; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.6); opacity: 0; } }

        /* PAD DO PODPISU */
        #signature-section { display: none; margin-top: 20px; }
        canvas { border: 2px dashed #ccc; border-radius: 8px; background: #fafafa; touch-action: none; cursor: crosshair; }
        .btns { margin-top: 10px; display: flex; gap: 10px; justify-content: center; }
        button { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-save { background: #28a745; color: white; }
        .btn-clear { background: #6c757d; color: white; }
        input[type="text"] { padding: 10px; width: 80%; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }

        /* LISTA PODPIS√ìW */
        #history { margin-top: 50px; }
        .sig-entry { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 12px; }
        .sig-entry img { height: 40px; background: white; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìú Regulamin & Akceptacja</h1>
    
    <div class="rules-box">
        <h2>Punktacja w sytuacjach remisowych</h2>
        <table>
            <tr><th>Sytuacja</th><th>Punkty</th></tr>
            <tr><td>Dwie osoby 1. miejsce</td><td>Obie po 3 pkt. Miejsce 2. usuniƒôte. 3. miejsce dostaje 1 pkt.</td></tr>
            <tr><td>Trzy osoby 1. miejsce</td><td>Wszystkie po 3 pkt. Brak pkt za 2 i 3 miejsce.</td></tr>
            <tr><td>Jedna 1., dwie 2.</td><td>1. miejsce (3 pkt), obie osoby na 2. po 2 pkt. Brak pkt za 3.</td></tr>
        </table>
    </div>

    <div class="acceptance-flow">
        <div id="step-1">
            <h3>KROK 1: Skan biometryczny</h3>
            <p>Przytrzymaj "kciuk" przez 2 sekundy.</p>
            <div id="scan-zone"><div class="pulse" id="pulse-ring"></div>‚òùÔ∏è</div>
            <div id="status">OCZEKIWANIE...</div>
        </div>

        <div id="signature-section">
            <h3>KROK 2: Podpis elektroniczny</h3>
            <input type="text" id="signer-name" placeholder="Wpisz swoje imiƒô / ksywkƒô">
            <canvas id="sig-canvas" width="300" height="150"></canvas>
            <div class="btns">
                <button class="btn-clear" id="clear-btn">Wyczy≈õƒá</button>
                <button class="btn-save" id="save-btn">Wy≈õlij Podpis</button>
            </div>
        </div>
    </div>

    <div id="history">
        <h3>Lista Akceptacji (≈öwiadkowie)</h3>
        <div id="sig-list">≈Åadowanie...</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCEEVCSx2uOOggu_4y_gUo4WMyKqf-HlKI",
        authDomain: "obstaiwanie.firebaseapp.com",
        projectId: "obstaiwanie"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- SKANER ---
    const scanZone = document.getElementById('scan-zone');
    const status = document.getElementById('status');
    const sigSection = document.getElementById('signature-section');
    let scanTimer;

    function startScan(e) {
        e.preventDefault();
        document.getElementById('pulse-ring').style.opacity = "1";
        status.textContent = "SKANOWANIE...";
        scanTimer = setTimeout(() => {
            document.getElementById('step-1').style.display = "none";
            sigSection.style.display = "block";
        }, 2000);
    }

    function stopScan() {
        clearTimeout(scanTimer);
        document.getElementById('pulse-ring').style.opacity = "0";
        if (sigSection.style.display !== "block") status.textContent = "SKAN PRZERWANY!";
    }

    scanZone.addEventListener('mousedown', startScan);
    scanZone.addEventListener('mouseup', stopScan);
    scanZone.addEventListener('touchstart', startScan);
    scanZone.addEventListener('touchend', stopScan);

    // --- CANVAS DO PODPISU ---
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    canvas.addEventListener('mousedown', (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); });
    canvas.addEventListener('mousemove', (e) => { if(drawing) { ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); } });
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); drawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); if(drawing) { ctx.lineTo(getPos(e).x, getPos(e).y); ctx.stroke(); } });
    canvas.addEventListener('touchend', () => drawing = false);

    document.getElementById('clear-btn').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);

    // --- ZAPIS DO FIREBASE ---
    document.getElementById('save-btn').onclick = async () => {
        const name = document.getElementById('signer-name').value;
        if(!name) return alert("Wpisz imiƒô!");
        
        const imgData = canvas.toDataURL("image/png");
        await addDoc(collection(db, "signatures"), {
            name: name,
            sig: imgData,
            date: new Date().toLocaleString("pl-PL"),
            ts: Date.now()
        });
        
        sigSection.innerHTML = "<h4>‚úÖ Dziƒôkujemy! Regulamin zaakceptowany.</h4>";
    };

    // --- LISTA ≈öWIADK√ìW ---
    onSnapshot(query(collection(db, "signatures"), orderBy("ts", "desc"), limit(10)), (snap) => {
        const list = document.getElementById('sig-list');
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            list.innerHTML += `
                <div class="sig-entry">
                    <div><strong>${d.name}</strong><br><small>${d.date}</small></div>
                    <img src="${d.sig}">
                </div>`;
        });
    });
</script>
</body>
</html>
