<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Regulamin & Akceptacja - Obstawianie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f2f2f2; margin: 0; padding: 15px; display: flex; justify-content: center; transition: 0.3s; }
        body.dark { background: #121212; color: #eee; }
        
        .container { max-width: 800px; width: 100%; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        body.dark .container { background: #1e1e1e; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        h1 { text-align: center; color: #007bff; font-size: 24px; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 25px; font-size: 20px; }
        p { font-size: 14px; line-height: 1.5; }
        
        .point-box { background: #e9f4ff; padding: 12px; border-radius: 8px; border-left: 5px solid #007bff; margin: 15px 0; font-size: 14px; }
        body.dark .point-box { background: #253a4e; border-left-color: #0056b3; color: #ccc; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        body.dark th, body.dark td { border-color: #444; }
        th { background: #f8f9fa; }
        body.dark th { background: #2a2a2a; }

        #darkModeBtn { 
            position: fixed; top: 10px; right: 10px; padding: 8px 12px; 
            border-radius: 20px; border: none; cursor: pointer; 
            background: #111; color: #fff; font-weight: bold; font-size: 12px; z-index: 1000;
        }
        body.dark #darkModeBtn { background: #f1f1f1; color: #111; }

        /* SEKCJA AKCEPTACJI */
        .acceptance-flow { text-align: center; margin-top: 30px; padding: 20px; border: 2px dashed #007bff; border-radius: 15px; }
        
        #scan-zone {
            width: 90px; height: 90px; background: #fff; border: 4px solid #007bff;
            border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;
            font-size: 40px; cursor: pointer; position: relative; transition: 0.3s; margin: 15px auto;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        #scan-zone.active { background: #007bff; transform: scale(0.9); }
        .pulse { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 4px solid #007bff; animation: pulse 1.5s infinite; opacity: 0; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.6); opacity: 0; } }

        #signature-section { display: none; margin-top: 15px; }
        canvas { border: 2px solid #ccc; border-radius: 8px; background: #fafafa; touch-action: none; cursor: crosshair; max-width: 100%; height: auto; }
        
        .btns { margin-top: 15px; display: flex; gap: 8px; justify-content: center; }
        button.action { padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-save { background: #28a745; color: white; }
        .btn-clear { background: #6c757d; color: white; }
        
        /* POPRAWKA: MNIEJSZY I WY≈öRODKOWANY INPUT */
        input#signer-name { 
            padding: 10px; 
            width: 80%; 
            max-width: 220px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            border: 1px solid #ccc; 
            font-size: 15px; 
            text-align: center;
            display: inline-block;
        }

        #history { margin-top: 40px; }
        .sig-entry { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; gap: 15px; }
        body.dark .sig-entry { border-bottom-color: #333; }
        
        /* POPRAWKA: UJEDNOLICONE ROZMIARY PODPIS√ìW */
        .sig-entry img { 
            width: 130px; 
            height: 60px; 
            object-fit: contain; 
            background: white; 
            border-radius: 5px; 
            border: 1px solid #ddd;
        }
        .sig-info { text-align: left; flex: 1; }
        .sig-info strong { font-size: 15px; display: block; margin-bottom: 2px; }
        .sig-info small { font-size: 11px; color: #777; }
    </style>
</head>
<body>

<button id="darkModeBtn">üåô Dark mode</button>

<div class="container">
    <h1>üìú Regulamin Gry</h1>

    <section>
        <h2>1. Zasady Og√≥lne</h2>
        <p>Celem gry jest wytypowanie godziny, kt√≥ra bƒôdzie jak najbli≈ºsza momentowi zatrzymania zegara przez administratora (przycisk STOP). Ka≈ºdy uczestnik mo≈ºe oddaƒá jeden g≈Ços w danej rundzie.</p>
    </section>

    <section>
        <h2>2. System Punktacji (Remisy)</h2>
        <p>Punkty przyznawane sƒÖ trzem najlepszym wynikom. W przypadku uzyskania identycznego czasu przez wielu graczy, stosujemy sportowy system miejsc dzielonych:</p>
        
        <div class="point-box">
            ü•á 1. miejsce: <b>3 pkt</b> | ü•à 2. miejsce: <b>2 pkt</b> | ü•â 3. miejsce: <b>1 pkt</b>
        </div>

        <table>
            <tr>
                <th>Sytuacja</th>
                <th>Podzia≈Ç Punkt√≥w</th>
            </tr>
            <tr>
                <td>2 osoby na 1. miejscu</td>
                <td>Obie po 3 pkt. Brak 2. miejsca. Kolejna osoba zajmuje 3. miejsce (1 pkt).</td>
            </tr>
            <tr>
                <td>3 osoby na 1. miejscu</td>
                <td>Wszystkie po 3 pkt. Brak pkt za miejsca 2 i 3.</td>
            </tr>
            <tr>
                <td>1 osoba 1., 2 osoby na 2.</td>
                <td>Lider 3 pkt, obie osoby na 2. miejscu po 2 pkt. Brak punkt√≥w za 3. miejsce.</td>
            </tr>
        </table>
    </section>

    <div class="acceptance-flow">
        <div id="step-1">
            <h3>üîê Akceptacja Regulaminu</h3>
            <p>KROK 1: Przytrzymaj palec na skanerze (1.5 sek), aby zweryfikowaƒá to≈ºsamo≈õƒá.</p>
            <div id="scan-zone">
                <div class="pulse" id="pulse-ring"></div>
                ‚òùÔ∏è
            </div>
            <div id="status" style="font-size: 13px; font-weight: bold;">DOTKNIJ I PRZYTRZYMAJ</div>
        </div>

        <div id="signature-section">
            <h3>‚úçÔ∏è Podpis Elektroniczny</h3>
            <p>KROK 2: Wpisz imiƒô i z≈Ç√≥≈º podpis palcem na polu poni≈ºej.</p>
            <input type="text" id="signer-name" placeholder="Twoje imiƒô / ksywka">
            <br>
            <canvas id="sig-canvas" width="300" height="130"></canvas>
            <div class="btns">
                <button class="action btn-clear" id="clear-btn">Wyczy≈õƒá</button>
                <button class="action btn-save" id="save-btn">Zatwierd≈∫</button>
            </div>
        </div>
    </div>

    <div id="history">
        <h3>üìÑ Lista Akceptacji (≈öwiadkowie)</h3>
        <div id="sig-list">Pobieranie listy ≈õwiadk√≥w...</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCEEVCSx2uOOggu_4y_gUo4WMyKqf-HlKI",
        authDomain: "obstaiwanie.firebaseapp.com",
        projectId: "obstaiwanie"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* DARK MODE LOGIC */
    const darkBtn = document.getElementById('darkModeBtn');
    darkBtn.onclick = () => {
        document.body.classList.toggle('dark');
        darkBtn.textContent = document.body.classList.contains('dark') ? "‚òÄÔ∏è Light mode" : "üåô Dark mode";
    };

    /* SCANNER LOGIC */
    const scanZone = document.getElementById('scan-zone');
    const status = document.getElementById('status');
    const sigSection = document.getElementById('signature-section');
    const pulse = document.getElementById('pulse-ring');
    let scanTimer;

    function startScan(e) {
        e.preventDefault();
        pulse.style.opacity = "1";
        scanZone.classList.add('active');
        status.textContent = "SKANOWANIE BIOMETRII...";
        scanTimer = setTimeout(() => {
            document.getElementById('step-1').style.display = "none";
            sigSection.style.display = "block";
        }, 1500);
    }

    function stopScan() {
        clearTimeout(scanTimer);
        pulse.style.opacity = "0";
        scanZone.classList.remove('active');
        if (sigSection.style.display !== "block") status.textContent = "SKANOWANIE PRZERWANE!";
    }

    scanZone.addEventListener('mousedown', startScan);
    scanZone.addEventListener('mouseup', stopScan);
    scanZone.addEventListener('touchstart', startScan);
    scanZone.addEventListener('touchend', stopScan);

    /* SIGNATURE LOGIC */
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    canvas.addEventListener('mousedown', (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); });
    canvas.addEventListener('mousemove', (e) => { if(drawing) { ctx.lineTo(getPos(e).x, getPos(e).y); ctx.lineWidth = 2; ctx.stroke(); } });
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); drawing = true; ctx.beginPath(); ctx.moveTo(getPos(e).x, getPos(e).y); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); if(drawing) { ctx.lineTo(getPos(e).x, getPos(e).y); ctx.lineWidth = 2; ctx.stroke(); } });
    canvas.addEventListener('touchend', () => drawing = false);

    document.getElementById('clear-btn').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);

    /* FIREBASE SAVE */
    document.getElementById('save-btn').onclick = async () => {
        const name = document.getElementById('signer-name').value;
        if(!name) return alert("Podaj swoje imiƒô lub ksywkƒô!");
        
        const imgData = canvas.toDataURL("image/png");
        await addDoc(collection(db, "signatures"), {
            name: name,
            sig: imgData,
            date: new Date().toLocaleString("pl-PL"),
            ts: Date.now()
        });
        
        document.querySelector('.acceptance-flow').innerHTML = "<h3 style='color: #28a745'>‚úÖ Regulamin zaakceptowany pomy≈õlnie!</h3>";
    };

    /* REALTIME LIST */
    onSnapshot(query(collection(db, "signatures"), orderBy("ts", "desc"), limit(10)), (snap) => {
        const list = document.getElementById('sig-list');
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            list.innerHTML += `
                <div class="sig-entry">
                    <div class="sig-info"><strong>${d.name}</strong><small>${d.date}</small></div>
                    <img src="${d.sig}">
                </div>`;
        });
    });
</script>
</body>
</html>
