<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Lista osób i Stoper</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 20px; display: flex; justify-content: center; }
        body.dark { background: #121212; color: white; }
        .container { max-width: 1100px; width: 100%; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        body.dark .container { background: #1e1e1e; }
        .flex { display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        body.dark th, body.dark td { border-color: #333; }
        .panel { flex: 1; min-width: 300px; }
        #clock { font-size: 48px; font-weight: bold; text-align: center; margin: 20px 0; }
        #stopBtn { background: red; color: white; padding: 20px 45px; font-size: 28px; border-radius: 60px; border: none; cursor: pointer; display: block; margin: 15px auto; }
        #winner { margin-top: 30px; padding: 20px; font-size: 20px; background: #d1ffd1; border-left: 5px solid green; display: none; text-align: center; color: #000; }
        .deleteBtn { color: red; cursor: pointer; font-weight: bold; }
        .blink { background: #d1ffd1 !important; color: #000 !important; font-weight: bold; }
    </style>
</head>
<body class="dark">

<div class="container">
    <h2>Lista zapisanych osób</h2>
    <div class="flex">
        <div class="panel">
            <button onclick="clearUsers()" style="margin-bottom:10px;">Wyczyść listę osób</button>
            <table id="table">
                <tr><th>No.</th><th>Imię</th><th>Godzina</th><th>X</th></tr>
            </table>
        </div>
        <div class="panel">
            <div id="clock">--:--:--</div>
            <button id="stopBtn">STOP</button>
            <div id="stoppedTime" style="text-align:center;"></div>
        </div>
    </div>
    <div id="winner"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, updateDoc, deleteDoc, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCEEVCSx2uOOggu_4y_gUo4WMyKqf-HlKI",
    authDomain: "obstaiwanie.firebaseapp.com",
    projectId: "obstaiwanie"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let usersData = [];

// Pobieranie osób
onSnapshot(collection(db, "users"), snap => {
    usersData = [];
    snap.forEach(d => usersData.push({ id: d.id, ...d.data() }));
    renderTable();
});

function toSec(t) {
    const p = t.split(":").map(Number);
    return (p[0]||0)*3600 + (p[1]||0)*60 + (p[2]||0);
}

function renderTable() {
    const now = new Date();
    const s = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
    const sorted = [...usersData].sort((a,b) => Math.abs(toSec(a.hour)-s) - Math.abs(toSec(b.hour)-s));
    
    const table = document.getElementById("table");
    table.innerHTML = "<tr><th>No.</th><th>Imię</th><th>Godzina</th><th>X</th></tr>";
    sorted.forEach((u, i) => {
        table.innerHTML += `<tr class="${i===0?'blink':''}"><td>${i+1}</td><td>${u.name}</td><td>${u.hour}</td><td><span class="deleteBtn" onclick="deleteUser('${u.id}')">X</span></td></tr>`;
    });
}

window.deleteUser = id => deleteDoc(doc(db, "users", id));
window.clearUsers = async () => {
    const snap = await getDocs(collection(db, "users"));
    snap.forEach(d => deleteDoc(doc(db, "users", d.id)));
};

setInterval(() => {
    document.getElementById("clock").textContent = new Date().toLocaleTimeString("pl-PL");
    renderTable();
}, 1000);

// Logika STOP i przyznawania punktów
document.getElementById("stopBtn").onclick = async () => {
    if(!usersData.length) return;
    const now = new Date();
    const s = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
    const sorted = [...usersData].sort((a,b) => Math.abs(toSec(a.hour)-s) - Math.abs(toSec(b.hour)-s));
    
    const top3 = sorted.slice(0, 3);
    const winDiv = document.getElementById("winner");
    winDiv.style.display = "block";
    winDiv.innerHTML = "<strong>Wyniki rundy:</strong><br>";

    for(let i=0; i < top3.length; i++) {
        const p = top3[i];
        const pts = (i === 0) ? 3 : (i === 1) ? 2 : 1;
        winDiv.innerHTML += `${i+1}. ${p.name} (+${pts} pkt)<br>`;

        const ref = doc(db, "ranking", p.name);
        const snap = await getDoc(ref);
        if(snap.exists()) {
            await updateDoc(ref, { points: increment(pts) });
        } else {
            await setDoc(ref, { points: pts });
        }
    }
};
</script>
</body>
</html>
