<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Lista u≈ºytkownik√≥w</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ===== PODSTAWA ===== */
body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
    transition: background-color 0.3s, color 0.3s;
}

.container {
    max-width: 1100px;
    width: 100%;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
}

h2 { text-align: center; }

.flex {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

th, td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: center;
    color: black;
}

th { background: #eee; }

th.deleteCell, td.deleteCell {
    width: 40px;
    padding: 5px;
}

.deleteBtn {
    width: 28px;
    height: 28px;
    line-height: 28px;
    border-radius: 50%;
    background: #ffdddd;
    border: 1px solid red;
    color: red;
    font-weight: bold;
    cursor: pointer;
}

.panel { flex: 1; min-width: 300px; }

#clock {
    font-size: 48px;
    font-weight: bold;
    text-align: center;
    margin-bottom: 20px;
}

#stopBtn {
    background: red;
    color: white;
    padding: 20px 40px;
    font-size: 28px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
}

button.clear {
    margin-bottom: 10px;
    padding: 10px;
    background: #444;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 6px;
}

/* ===== DARK MODE ===== */
body.dark {
    background: #121212;
    color: #eee;
}

body.dark .container {
    background: #1e1e1e;
}

body.dark table {
    background: #1e1e1e;
}

body.dark th {
    background: #2a2a2a;
    color: #fff;
}

body.dark td {
    background: #1e1e1e;
    color: #ddd;
}

body.dark button.clear {
    background: #666;
}

body.dark #stopBtn {
    background: #b30000;
}

body.dark .deleteBtn {
    background: #3a0000;
    border-color: #ff4444;
    color: #ff8888;
}

/* ===== TOGGLE ===== */
#themeToggle {
    position: fixed;
    top: 15px;
    right: 15px;
    font-size: 24px;
    background: transparent;
    border: none;
    cursor: pointer;
    z-index: 100000;
}

/* ===== MIGANIE ===== */
@keyframes blinkGreen {
    0% { background-color: #d1ffd1; }
    50% { background-color: #006400; }
    100% { background-color: #d1ffd1; }
}

.blink { animation: blinkGreen 1.5s infinite; }
.blink td { color: white; font-weight: bold; }

/* ===== CRINGE BG ===== */
@keyframes cringeBg {
    0% { background-color: #ff69b4; }
    25% { background-color: #00ffff; }
    50% { background-color: #ffff00; }
    75% { background-color: #ff00ff; }
    100% { background-color: #00ff00; }
}
</style>
</head>

<body>

<button id="themeToggle">üåô</button>

<div class="container">
<h2>Lista zapisanych os√≥b</h2>

<div class="flex">
<div class="panel">
<button class="clear" onclick="clearAll()">Wyczy≈õƒá wszystkie dane</button>
<table id="table">
<tr>
<th>No.</th>
<th>Imiƒô</th>
<th>Godzina</th>
<th class="deleteCell">X</th>
</tr>
</table>
</div>

<div class="panel">
<div id="clock">--:--:--</div>
<button id="stopBtn">STOP</button>
<div id="stoppedTime"></div>
</div>
</div>

<div id="winner"></div>
</div>

<audio id="fanfareAudio" src="fanfare1.mp3" preload="auto"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCEEVCSx2uOOggu_4y_gUo4WMyKqf-HlKI",
  authDomain: "obstaiwanie.firebaseapp.com",
  projectId: "obstaiwanie",
  storageBucket: "obstaiwanie.firebasestorage.app",
  messagingSenderId: "64783465818",
  appId: "1:64783465818:web:0a9aa45acf40e351ae8763"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const table = document.getElementById("table");
let usersData = [];

/* ===== REALTIME ===== */
onSnapshot(collection(db, "users"), (snapshot) => {
    usersData = [];
    snapshot.forEach(d => usersData.push({ id: d.id, ...d.data() }));
});

/* ===== CLOCK ===== */
const clock = document.getElementById("clock");
setInterval(() => {
    const now = new Date();
    clock.textContent = now.toLocaleTimeString("pl-PL");
    updateTable(now);
}, 1000);

function toSeconds(t) {
    const p = t.split(":").map(Number);
    return (p[0]||0)*3600 + (p[1]||0)*60 + (p[2]||0);
}

function updateTable(now) {
    const cur = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
    const sorted = [...usersData].sort((a,b)=>
        Math.abs(toSeconds(a.hour)-cur)-Math.abs(toSeconds(b.hour)-cur)
    );

    table.innerHTML = `
    <tr>
    <th>No.</th><th>Imiƒô</th><th>Godzina</th><th>X</th>
    </tr>`;

    sorted.forEach((u,i)=>{
        table.innerHTML += `
        <tr class="${i===0?'blink':''}">
        <td>${i+1}</td>
        <td>${u.name}</td>
        <td>${u.hour}</td>
        <td><span class="deleteBtn" onclick="deleteOne('${u.id}')">X</span></td>
        </tr>`;
    });
}

/* ===== ACTIONS ===== */
window.deleteOne = async id => deleteDoc(doc(db,"users",id));

window.clearAll = async () => {
    const s = await getDocs(collection(db,"users"));
    s.forEach(d=>deleteDoc(doc(db,"users",d.id)));
};

/* ===== STOP ===== */
document.getElementById("stopBtn").onclick = () => {
    if(!usersData.length) return;
    document.body.style.animation="cringeBg .3s infinite alternate";
    document.getElementById("fanfareAudio").play();
    setTimeout(()=>document.body.style.animation="none",7000);
};

/* ===== DARK MODE ===== */
const toggle = document.getElementById("themeToggle");

if(localStorage.getItem("theme")==="dark"){
    document.body.classList.add("dark");
    toggle.textContent="‚òÄÔ∏è";
}

toggle.onclick = () => {
    document.body.classList.toggle("dark");
    const dark = document.body.classList.contains("dark");
    toggle.textContent = dark ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("theme", dark?"dark":"light");
};
</script>

</body>
</html>
