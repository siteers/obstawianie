<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Lista uÅ¼ytkownikÃ³w</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
  margin: 0;
  padding: 20px;
  display: flex;
  justify-content: center;
  transition: background-color 0.3s;
}

body.dark {
  background: #121212;
}

.container {
  max-width: 1100px;
  width: 100%;
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0,0,0,0.2);
}

body.dark .container {
  background: #1e1e1e;
  box-shadow: 0 0 20px rgba(255,255,255,0.05);
}

h2 { text-align: center; }

body.dark h2,
body.dark th,
body.dark td,
body.dark #clock,
body.dark #stoppedTime {
  color: #f1f1f1;
}

.flex { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

body.dark table {
  background: #1e1e1e;
}

th, td {
  border: 1px solid #ccc;
  padding: 10px;
  text-align: center;
  font-weight: normal;
  color: black;
}

body.dark th, body.dark td {
  border-color: #333;
}

th { background: #eee; }
body.dark th { background: #2a2a2a; }

th.deleteCell, td.deleteCell { width: 40px; padding: 5px; }

.deleteBtn {
  display: inline-block;
  width: 28px;
  height: 28px;
  line-height: 28px;
  border-radius: 50%;
  background: #ffdddd;
  border: 1px solid red;
  color: red;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}

body.dark .deleteBtn {
  background: #3a1a1a;
  border-color: #ff4d4d;
  color: #ff4d4d;
}

.deleteBtn:hover { background: red; color: white; }

.panel { flex: 1; min-width: 300px; }

#clock {
  font-size: 48px;
  font-weight: bold;
  text-align: center;
  margin-bottom: 20px;
}

#stopBtn {
  background: red;
  color: white;
  padding: 20px 40px;
  font-size: 28px;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  display: block;
  margin: auto;
}

#stopBtn:active { transform: scale(0.95); }

#stoppedTime { font-size: 28px; margin-top: 20px; text-align: center; }

#winner {
  margin-top: 30px;
  padding: 20px;
  font-size: 24px;
  background: #d1ffd1;
  border-left: 5px solid green;
  display: none;
  text-align: center;
}

body.dark #winner {
  background: #1f3d1f;
  color: #aaffaa;
}

button.clear {
  margin-bottom: 10px;
  padding: 10px;
  background: #444;
  color: white;
  border: none;
  cursor: pointer;
  border-radius: 6px;
}

button.clear:hover { background: black; }

#darkModeBtn {
  position: fixed;
  top: 15px;
  right: 15px;
  padding: 10px 16px;
  border-radius: 30px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  background: #222;
  color: white;
  z-index: 100000;
}

body.dark #darkModeBtn {
  background: #eee;
  color: black;
}

#fireworksCanvas {
  position: fixed;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 9999;
  display: none;
}

#cringeGifs {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 99999;
  display: none;
  gap: 10px;
  width: 90%;
  max-width: 800px;
}

#cringeGifs img {
  max-height: 150px;
  border-radius: 10px;
}

@keyframes blinkGreen {
  0% { background-color: #d1ffd1; }
  50% { background-color: #006400; }
  100% { background-color: #d1ffd1; }
}

.blink { animation: blinkGreen 1.5s infinite; }
.blink td { color: white !important; font-weight: bold !important; }

@keyframes cringeBg {
  0% { background-color: #ff69b4; }
  25% { background-color: #00ffff; }
  50% { background-color: #ffff00; }
  75% { background-color: #ff00ff; }
  100% { background-color: #00ff00; }
}
</style>
</head>

<body>

<button id="darkModeBtn">ðŸŒ™ Dark mode</button>

<div class="container">
<h2>Lista zapisanych osÃ³b</h2>

<div class="flex">
<div class="panel">
<button class="clear" onclick="clearAll()">WyczyÅ›Ä‡ wszystkie dane</button>
<table id="table">
<tr>
<th>No.</th>
<th>ImiÄ™</th>
<th>Godzina</th>
<th class="deleteCell">X</th>
</tr>
</table>
</div>

<div class="panel">
<div id="clock">--:--:--</div>
<button id="stopBtn">STOP</button>
<div id="stoppedTime"></div>
</div>
</div>

<div id="winner"></div>
</div>

<canvas id="fireworksCanvas"></canvas>

<div id="cringeGifs">
<img src="https://media.giphy.com/media/3oz8xAFtqoOUUrsh7W/giphy.gif">
<img src="https://media.giphy.com/media/l0ExncehJzexFpRHq/giphy.gif">
<img src="https://media.giphy.com/media/xT5LMHxhOfscxPfIfm/giphy.gif">
</div>

<audio id="fanfareAudio" src="fanfare1.mp3" preload="auto"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ===== DARK MODE ===== */
const darkBtn = document.getElementById("darkModeBtn");
if (localStorage.getItem("darkMode") === "on") {
  document.body.classList.add("dark");
  darkBtn.textContent = "â˜€ï¸ Light mode";
}
darkBtn.onclick = () => {
  document.body.classList.toggle("dark");
  const d = document.body.classList.contains("dark");
  darkBtn.textContent = d ? "â˜€ï¸ Light mode" : "ðŸŒ™ Dark mode";
  localStorage.setItem("darkMode", d ? "on" : "off");
};

/* ===== FIREBASE ===== */
const firebaseConfig = {
apiKey: "AIzaSyCEEVCSx2uOOggu_4y_gUo4WMyKqf-HlKI",
authDomain: "obstaiwanie.firebaseapp.com",
projectId: "obstaiwanie",
storageBucket: "obstaiwanie.firebasestorage.app",
messagingSenderId: "64783465818",
appId: "1:64783465818:web:0a9aa45acf40e351ae8763"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const table = document.getElementById("table");
let usersData = [];

onSnapshot(collection(db, "users"), (snapshot) => {
  usersData = [];
  snapshot.forEach((d) => usersData.push({ id: d.id, ...d.data() }));
});

window.deleteOne = async (id) => {
  await deleteDoc(doc(db, "users", id));
};

window.clearAll = async () => {
  const snap = await getDocs(collection(db, "users"));
  snap.forEach(async d => await deleteDoc(doc(db, "users", d.id)));
  stoppedTime.textContent = "";
  winner.style.display = "none";
};

/* ===== CLOCK ===== */
const clock = document.getElementById("clock");
setInterval(() => {
  const now = new Date();
  clock.textContent = now.toLocaleTimeString("pl-PL");
  updateTableRealtime(now);
}, 1000);

function toSeconds(t) {
  const p = t.split(":").map(Number);
  return (p[0]||0)*3600 + (p[1]||0)*60 + (p[2]||0);
}

function updateTableRealtime(now) {
  const sec = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
  const sorted = [...usersData].sort((a,b)=>Math.abs(toSeconds(a.hour)-sec)-Math.abs(toSeconds(b.hour)-sec));
  table.innerHTML = `
  <tr>
    <th>No.</th><th>ImiÄ™</th><th>Godzina</th><th class="deleteCell">X</th>
  </tr>`;
  sorted.forEach((u,i)=>{
    table.innerHTML += `
    <tr class="${i===0?'blink':''}">
      <td>${i+1}</td>
      <td>${u.name}</td>
      <td>${u.hour}</td>
      <td class="deleteCell"><span class="deleteBtn" onclick="deleteOne('${u.id}')">X</span></td>
    </tr>`;
  });
}

/* ===== STOP ===== */
stopBtn.onclick = () => {
  if (!usersData.length) return;
  stoppedTime.textContent = "Zatrzymana godzina: " + clock.textContent;
  const now = new Date();
  const sec = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
  const best = [...usersData].sort((a,b)=>Math.abs(toSeconds(a.hour)-sec)-Math.abs(toSeconds(b.hour)-sec))[0];
  winner.style.display = "block";
  winner.textContent = `ðŸ† ZwyciÄ™zca: ${best.name} (${best.hour})`;
  document.body.style.animation="cringeBg 0.3s infinite alternate";
  fanfareAudio.currentTime=0; fanfareAudio.play().catch(()=>{});
  setTimeout(()=>document.body.style.animation="none",7000);
};
</script>

</body>
</html>
